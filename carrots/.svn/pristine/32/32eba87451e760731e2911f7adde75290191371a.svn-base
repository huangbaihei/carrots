angular.module('myApp')
    .controller('companyListCtrl', function ($rootScope, $state, $stateParams, requestSvc, searchPanel, commonUtil) {
        $(window).scrollTop(0);
        let vm = this;
        let urlArray = [];
        let searchPanelCopy = angular.copy(searchPanel);
        //用来存放url的参数和常量
        vm.financing = searchPanelCopy.financing;
        vm.industry = searchPanelCopy.industry;
        vm.city = searchPanelCopy.city;
        vm.params = $state.params;
        //搜索栏刷新状态保持
        vm.cities = commonUtil.keepSelect($stateParams.city, urlArray, vm.city, vm.cities);
        vm.industries = commonUtil.keepSelect($stateParams.industry, urlArray, vm.industry, vm.industries);
        vm.financings = commonUtil.keepSelect($stateParams.financing, urlArray, vm.financing, vm.financings);
        requestSvc.getCompanyList(vm.params).then(function (res) {
            if (res.data.code === 0) {
                vm.result = (res.data.data.length === 0);
                vm.companiesList = res.data.data;
                vm.total = res.data.total;
                vm.page = $stateParams.page || 1;
                vm.size = $stateParams.size || 9;

            }
        });
        //城市搜索栏
        vm.chooseCity = function (index, beChosen) {
            if (index === 0) {
                vm.cities = commonUtil.choseUnlimited(vm.city, vm.cities)
            } else {
                vm.cities = commonUtil.checkBox(vm.city, vm.cities, index, beChosen);
                //所有选项都不选的时候重置为不限
                vm.city[0].choose = vm.city.every(function (item) {
                    return item.choose === false;
                });
            }
            vm.params.city = vm.cities.length !== 0 ? vm.cities.join() : undefined;
        };
        //融资阶段搜索栏
        vm.chooseFinancing = function (index, beChosen) {
            if (index === 0) {
                vm.financings = commonUtil.choseUnlimited(vm.financing, vm.financings);

            } else {

                vm.financings = commonUtil.checkBox(vm.financing, vm.financings, index, beChosen);
                //所有选项都不选的时候重置为不限
                vm.financing[0].choose = vm.financing.every(function (item) {
                    return item.choose === false;
                });
            }
            vm.params.financing = vm.financings.length !== 0 ? vm.financings.join() : undefined;
        };
        //行业搜索栏
        vm.chooseIndustry = function (index, beChosen) {
            if (index === 0) {
                vm.industries = commonUtil.choseUnlimited(vm.industry, vm.industries)
            } else {
                vm.industries = commonUtil.checkBox(vm.industry, vm.industries, index, beChosen);
                //所有选项都不选的时候重置为不限
                vm.industry[0].choose = vm.industry.every(function (item) {
                    return item.choose === false;
                });
            }
            vm.params.industry = vm.industries.length !== 0 ? vm.industries.join() : undefined;
        };
        //搜索
        vm.companySearch = function () {
            $state.go('.', vm.params,
                {reload: true}
            );
        };

        //清除
        vm.companyClear = function () {
            angular.forEach(vm.params, function (item, index, array) {
                array[index] = undefined;
            });
            commonUtil.clearAll(vm.financing);
            commonUtil.clearAll(vm.industry);
            commonUtil.clearAll(vm.city);
            $state.go('.', vm.params, {
                reload: true
            });
        };
    });
