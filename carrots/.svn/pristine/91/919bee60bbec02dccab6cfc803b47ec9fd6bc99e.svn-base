angular.module('myApp')
    .controller('companyListCtrl', function ($rootScope, $state, $stateParams, requestSvc, searchPanel) {
        let vm = this;
        let urlArray = [];
        //用来存放url的参数和常量

        vm.financing = searchPanel.financing;
        vm.industry = searchPanel.industry;
        vm.city = searchPanel.city;
        // vm.params = sessionStorage.getItem("searchOptions") ? sessionStorage.getItem("searchOptions") : $state.params;
        vm.params = $state.params;
        //搜索栏刷新状态保持
        vm.cities = $rootScope.keepSelect($stateParams.city, urlArray, vm.city, vm.cities);
        vm.industries = $rootScope.keepSelect($stateParams.industry, urlArray, vm.industry, vm.industries);
        vm.financings = $rootScope.keepSelect($stateParams.financing, urlArray, vm.financing, vm.financings);

        console.log(vm.params);
        requestSvc.getCompanyList(vm.params).then(function (res) {
            console.log(res);
            if (res.data.code === 0) {
                vm.result = (res.data.data.length === 0);
                vm.companiesList = res.data.data;
                vm.total = res.data.total;
                vm.page = $stateParams.page || 1;
                vm.size = $stateParams.size || 9;
            } else {
                $rootScope.alert(res.data.message);
            }
        });
        //城市搜索栏
        vm.cities=[];
        vm.chooseCity = function (index, beChosen) {
            if (index === 0) {
                vm.cities = $rootScope.choseUnlimited(vm.city, vm.cities)
            } else {
                vm.cities = $rootScope.checkBox(vm.city, vm.cities, index, beChosen)
            }
            console.log(vm.cities);
            vm.params.city = vm.cities[0] ? vm.cities.join() : undefined;
        };
        //融资阶段搜索栏
        vm.financings=[];
        vm.chooseFinancing = function (index, beChosen) {
            if (index === 0) {
                vm.financings = $rootScope.choseUnlimited(vm.financing, vm.financings)
            } else {
                vm.financings = $rootScope.checkBox(vm.financing, vm.financings, index, beChosen)
            }
            console.log(vm.financings);
            vm.params.financing = vm.financings[0] ? vm.financings.join() : undefined;

        };
        //行业搜索栏
        vm.industries=[];
        vm.chooseIndustry = function (index, beChosen) {
            if (index === 0) {
                vm.industries = $rootScope.choseUnlimited(vm.industry, vm.industries)
            } else {
                vm.industries = $rootScope.checkBox(vm.industry, vm.industries, index, beChosen)
            }
            console.log(vm.industries);
            vm.params.industry = vm.industries[0] ? vm.industries.join() : undefined;
        };
        //搜索
        vm.companySearch = function () {
            // sessionStorage.searchOptions = JSON.stringify(vm.params);
            $state.go('.', vm.params, {
                reload: true
            });
            // console.log(vm.params);
        };

        //清除
        vm.companyClear = function () {
            angular.forEach(vm.params, function (item, index, array) {
                array[index] = undefined;
            });
            $rootScope.clearAll(vm.financing);
            $rootScope.clearAll(vm.industry);
            $rootScope.clearAll(vm.city);
            $state.go('.', vm.params, {
                reload: true
            });
        };
    });
