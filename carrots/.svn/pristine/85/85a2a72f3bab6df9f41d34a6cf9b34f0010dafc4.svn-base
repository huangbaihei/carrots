angular.module('myApp')
    .controller('companySearchCtrl', function ($rootScope, $state, $stateParams, requestSvc, searchPanel) {
        // $(window).scrollTop(0);
        let vm = this;
        let urlArray = [];
        //用来存放url的参数
        vm.params = $state.params;
        vm.name=[];
        vm.financing = searchPanel.financing;
        vm.industry = searchPanel.industry;
        vm.city = searchPanel.city;
        // console.log(vm.cities);

        //搜索栏刷新状态保持
        vm.cities = $rootScope.keepSelect($stateParams.city, urlArray, vm.city, vm.cities);
        vm.industries = $rootScope.keepSelect($stateParams.industry, urlArray, vm.industry, vm.industries);
        vm.financings = $rootScope.keepSelect($stateParams.financing, urlArray, vm.financing, vm.financings);

        // console.log(vm.params);
        requestSvc.getCompanyList(vm.params).then(function (res) {
            if (res.data.code === 0) {
                vm.result = (res.data.data.length === 0);
                vm.companiesList = res.data.data;
                vm.total = res.data.total;
                vm.page = $stateParams.page || 1;
                vm.size = $stateParams.size || 9;
            }
        });
        // 推荐公司数据
        vm.theSize = {
            size: 3
        };
        requestSvc.getCompanyList(vm.theSize).then(function (res) {
            if (res.data.code === 0){
                vm.topCompanyList = res.data.data;
            }else {
                $rootScope.alert(res.data.message);
            }
        });
        //城市搜索栏
        vm.chooseCity = function (index, beChosen) {
            if (index === 0) {
                vm.cities = $rootScope.choseUnlimited(vm.city, vm.cities)
            } else {
                vm.cities = $rootScope.checkBox(vm.city, vm.cities, index, beChosen)
            }
        };
        //融资阶段搜索栏
        vm.chooseFinancing = function (index, beChosen) {
            if (index === 0) {
                vm.financings = $rootScope.choseUnlimited(vm.financing, vm.financings)
            } else {
                vm.financings = $rootScope.checkBox(vm.financing, vm.financings, index, beChosen)
            }
        };
        //行业搜索栏
        vm.chooseIndustry = function (index, beChosen) {
            if (index === 0) {
                vm.industries = $rootScope.choseUnlimited(vm.industry, vm.industries)
            } else {
                vm.industries = $rootScope.checkBox(vm.industry, vm.industries, index, beChosen)
            }
        };
        //搜索
        vm.companySearch = function () {
            vm.params.name = vm.name;
            vm.params.city = vm.cities ? vm.cities.join() : undefined;
            vm.params.industry = vm.industries ? vm.industries.join() : undefined;
            vm.params.financing = vm.financings ? vm.financings.join() : undefined;
            $state.go('.', vm.params, {
                reload: true
            });
            // console.log(vm.params);
        };

        //清除
        vm.companyClear = function () {
            angular.forEach(vm.params, function (item, index, array) {
                array[index] = undefined;
            });
            $rootScope.clearAll(vm.name);
            $rootScope.clearAll(vm.financing);
            $rootScope.clearAll(vm.industry);
            $rootScope.clearAll(vm.city);
            $state.go('.', vm.params, {
                reload: true
            });
        };
    });
